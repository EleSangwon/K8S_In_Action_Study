# 서비스: 클라이언트가 포드를 검색하고 통신을 가능하게함 P200~

```
특정 포드는 외부 자극과는 별도로 작업을 수행할 수 있지만 대다수의 애플리케이션은
외부 요청에 응답하기 위한 것이다.

예를 들어, 마이크로서비스의 경우 포드는 대게 클러스터 내의 다른 포드의 요청이나
클러스터 외부의 클라이언트로부터 오는 HTTP 요청에 응답한다.
```

## 서비스 소개
```
쿠버네티스 서비스는 동일한 서비스를 제공하는 포드 그룹에 단일 진입 점을 만들기 위해
생성하는 리소스다.

각 서비스에는 서비스가 존재하는 동안 절대로 변경되지 않는 IP주소와 포트가 있다.

클라이언트는 해당 IP 및 포트에 연결할 수 있고,이 연결은 해당 서비스를
지원하는 포드 중 하나로 라우팅된다.

이렇게하면 서비스 클라이언트는 서비스를 제공하는 포드의 개별 위치와 무관해지므로
포드는 언제든지 클러스터 주변에서 이동할 수 있다
```

## 예제를 통한 서비스 설명
```
프론트엔드 웹 서버와 백엔드 데이터베이스 서버가 있다고 하자.

프론트 엔드로 동작하는 여러 개의 포드가 있을 수 있지만 하나의 백엔드 DB 포드만이
있을 수 있다. 시스템 기능을 만들기 위해 두 가지 문제를 해결해야 한다

- 외부 클라이언트는 단일 웹 서버든 수백 개의 서버든 관계없이 프론트엔드 포드로 
연결할 수 있어야 한다

- 프론트엔드 포드는 백엔드 DB에 연결할 수 있어야 한다.
DB는 포드 안에서 실행되기 때문에 포드는 시간에 지남에 따라 IP가 변경되면서 클러스터 상에서
이동할 수 있다. 백엔드 DB가 옮겨질 때마다 프론트엔드 포드를 재설정하지 않길 바란다.

프론트 포드를 위한 서비스를 생성하고 클러스터 외부로부터 액세스가 가능하게 설정해
클라이언트가 포드로 접속을 가능케 하는 고정 IP주소를 노출할 수 있다.

마찬가지로 백엔드 포드의 서비스를 작성하여 백엔드 포드에 안정적인 주소를 생성한다.
포드의 IP주소가 변경 되더라도 서비스의 IP주소는 변경되지 않는다.
```
![캡처1](https://user-images.githubusercontent.com/50174803/128696706-18f6bc90-a9e4-4994-b615-cb5ab92d7ca0.jpg)


## 서비스 생성
```
어떤 포드가 서비스의 일부인지 어떻게 식별할 수 있을까?

같은 라벨 셀렉터 세트를 사용한다.
```
![캡처2](https://user-images.githubusercontent.com/50174803/128721390-6741c169-0e7a-4169-9c3f-28477a78b7a0.jpg)

## 클러스터 안에서 서비스 테스트
```
몇 가지 방법을 통해 클러스터 내부의 서비스에게 요청을 전송할 수 있다.

- 서비스의 클러스터 IP주소로 요청을 보내고 응답을 로그로 남기는 포드를 생성하는 것
어떤 서비스가 응답했는지 포드의 로그를 통해서 확인할 수 있다.

- 쿠버네티스의 노드 중 하나로 SSH 접속을 수행하고 curl 명령을 사용할 수 있다.

- kubectl exec 명령어를 통해 이미 존재하는 포드들 중 하나에서 curl 명령을 수행

kubectl exec 명령을 통해 특정한 컨테이너의 포드 안에서 원격으로 임의의 명령어를 실행할 수 있다.

kubectl exec <특정포드이름> -- curl -s <서비스의IP주소>
```

![캡처3](https://user-images.githubusercontent.com/50174803/128722150-87ef8b3e-f89f-4d64-914b-fb09dfbb5088.jpg)

## 동일한 서비스에서 여러 개의 포트 노출

![캡처4](https://user-images.githubusercontent.com/50174803/128722522-8421e7be-0bd7-456e-b997-dcd08729b0a2.jpg)

## 클러스터 외부 서비스에 연결
```
서비스를 외부로 노출이 필요한 경우가 있다. 클러스터 내의 포드로 연결을 리다이렉트하는 서비스 대신에
외부의 IP와 포트로 리다이렉트해야 하는 경우가 있다.

이 경우 서비스 로드 밸런싱이나 서비스 디스커버리 수행 시 이점이 있다.
클러스터 내에 실행 중인 클라이언트 포드는 내부 서비스에 연결하는 것처럼 외부 서비스에 연결
할 수 있다.

서비스 엔드포인트 리소스는 서비스에 의해 노출되는 IP주소와 포트의 목록이다.

서비스의 엔드포인트를 서비스와 분리하면 엔드포인트를 수동으로 구성하고 업데이트할 수 있다.
포드 셀렉터 없이 서비스를 만들었다면 쿠버네티스는 엔드포인트 리소스조차 만들지 못한다.

수동으로 관리되는 엔드포인트를 사용해 서비스를 만들려면 서비스 및 엔드포인트
리소스를 모두 만들어야 한다.
```
![캡처5](https://user-images.githubusercontent.com/50174803/128724112-ae28c581-e2f4-4f7d-911b-8b85e3a016f3.jpg)
![캡처6](https://user-images.githubusercontent.com/50174803/128724127-20c5b742-eeeb-40f1-8f1c-33f463582ba6.jpg)
![캡처7](https://user-images.githubusercontent.com/50174803/128724222-bf8c3906-5c73-4434-b426-6292b4073347.jpg)

## 외부 서비스에서 외부 클라이언트로
```
서비스가 외부에서 액세스 가능하게 하는 방법

- NodePort 서비스 타입으로 설정하기

NodePort 서비스의 각 클러스터 노드는 노드 자체의 이름을 통해 포트를 열고 포트에서 발생한
트래픽을 서비스로 리다이렉트한다.

- LoadBalancer 서비스 타입으로 설정하기

쿠버네티스가 실행 중인 클라우드 인프라에 프로비저닝된 지정된 로드밸런서를 통해
서비스 액세스 가능하게 된다.
로드밸런서는 발생한 트래픽을 모든 노드에서 노드 포트로 리다이렉트한다. 
클라이언트는 로드 밸런서의 IP를 통해 서비스에 접속한다.

-하나의 IP 주소를 통해 여러 서비스를 제공하는 인그레스 리소스 생성하기

HTTP 레벨(네트워크 7계층) 수준에서 동작하기 때문에 4계층 서비스보다 
좀 더 기능을 제공한다.
```
![캡처8](https://user-images.githubusercontent.com/50174803/128724967-f56cf1c5-4b63-41da-a2a0-fccaeb923463.jpg)

## NodePort 서비스 사용
![캡처9](https://user-images.githubusercontent.com/50174803/128725242-f98b975b-20e8-46a3-b7f9-cfbd19d02118.jpg)

## LoadBalancer 를 이용한 서비스 노출
![캡처10](https://user-images.githubusercontent.com/50174803/128725474-a4e23ff7-c246-4418-bb08-2a1c18e3b884.jpg)
























