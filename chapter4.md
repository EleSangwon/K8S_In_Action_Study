# 레플리케이션과 그 밖의 컨트롤러 : 파드 배포 관리 P149 ~ 198

```
파드는 쿠버네티스에서 기본적인 배포가 가능한 유닛이다.

실제환경에서는 배포한 애플리케이션이 자동으로 로드하여 실행되고 
수동으로 개입하지 않아도 정상적으로 안정적 상태를 유지하기를 원할 것이다.

이렇게 하기 위해 수동적으로 파드를 만드는 일은 거의 없다.
대신 디플로이먼트 같은 유형의 리소스를 생성해 실제 파드를 만들고
관리하도록 맡겨둔다.
```

## 파드를 안정적으로 유지하기
```
쿠버네티스를 사용하면 얻을 수 있는 주요 장점 중 하나는 컨테이너 목록을
제공하고 클러스터에서 컨테이너를 계속 실행시킬 수 있다는 것이다.

만약 파드 중 하나가 종료되면 어떻게 될까? 파드의 모든 컨테이너가 종료되면
어떨까?

파드가 노드에 스케줄되자마자 해당 노드의 kubelet 은 컨테이너를 실행하고
파드가 존재하는 한 계속 실행한다.

컨테이너의 주 프로세스에 크래시가 발생하면 kubelet이 컨테이너를 다시 시작한다.

애플리케이션에 버그가 발생하면 쿠버네티스가 자동으로 다시 시작하므로
애플리케이션 자체에 특별한 작업을 하지않아도 쿠버네티스에서 실행 중인
애플리케이션을 자동으로 복구할 수 있다.

크래시가 발생한 컨테이너는 자동으로 다시 시작한다고 했다.
그러나 모든 문제를 해결하지는 못한다.

애플리케이션이 무한 루프 또는 교착 상태에 빠져 응답을 멈추는 상황은 어떨까?
이런 경우 애플리케이션이 다시 시작할 수 있도록 애플리케이션의 상태를
외부에서 체크하도록 하고 내부에서 수행하는 애플리케이션에 의존하지 않아야 한다.
```

## 라이브니스 프로브 
```
쿠버네티스는 라이브니스 프로브를 통해 컨테이너가 아직 살아 있는지 확인할 수 있다.
파드의 사양에서 각 컨테이너에 라이브니스 프로브를 지정할 수 있다.
쿠버네티스는 주기적으로 검사를 실행하고 검사가 실패한 경우 컨테이너를 다시 시작한다.

쿠버네티스는 세 가지 메커니즘 중 하나를 사용해 컨테이너를 검색한다.

- HTTP GET 프로브
지정한 IP주소, 포트, 경로에 HTTP GET 요청을 수행한다.
프로브가 응답을 수신하고 응답 코드가 오류를 나타내지 않으면 프로브는 
성공으로 간주한다.

서버가 오류 응답 코드를 리턴하거나 응답하지 않으면 프로브는 실패로
간주하고 컨테이너를 다시 시작한다.

- TCP 소켓 프로브
컨테이너의 지정된 포트에 TCP 연결을 열려고 시도한다.
성공적으로 연결되면 프로브가 성공한 것이고, 그렇지 않으면
컨테이너를 다시 시작한다.

- EXEC 프로브
컨테이너 내부에 임의의 명령을 실행하고 명령의 종료 상태 코드를
확인한다. 상태 코드가 0이면 검사가 성공이고,
다른 모든 코드는 오류로 간주한다.
```

## HTTP 기반 라이브니스 프로브 생성
```
Node.js 애플리케이션에 라이브니스 프로브를 추가해본다.

웹 애플리케이션이기 때문에 웹 서버가 요청을 처리하는 지 여부를 확인할
라이브니스 프로브를 추가하는 것이 좋다.

```
![캡처44](https://user-images.githubusercontent.com/50174803/128471022-f2effd4b-ef7e-495a-b316-92e3930fa981.jpg)

## 비정상적 컨테이너의 애플리케이션 로그 읽기
```
kubectl logs <pod이름> --previous
```

## 효과적인 라이브니스 프로브 생성
```
프로덕션 운영 환경에서 실행 중인 파드의 경우 항상 라이브니스 프로브를 정의해야 한다.
정의되지 않으면 쿠버네티스는 애플리케이션이 아직 살아 있는 지 여부를 알 수 없다.
프로세스가 실행되는 동안 쿠버네티스는 컨테이너가 정상적이라고 생각한다.
```

## 라이브니스 프로브 정리
```
쿠버네티스는 크래시가 발생하거나 라이브니스 프로브가 실패한 경우 컨테이너를 다시 시작해
컨테이너를 계속 실행한다.

이 작업은 파드를 호스팅하는 노드에서 kubelet에 의해 수행된다.
```

## 레플리카 소개
```
책에서는 레플리케이션컨트롤러지만, 이제는 레플리카를 사용한다.

레플리카는 파드가 항상 실행되도록 유지하는 쿠버네티스 리소스다.
노드가 클러스터에서 사라지는 경우 또는 노드에서 파드가 제거된 경우와 같이 어떤 이유로든
파드가 사라지면 레플리카는 이를 감지하고 대체 파드를 만든다.
```
![캡처55](https://user-images.githubusercontent.com/50174803/128542084-94bbeb62-c9f9-4f0c-afb4-7d76ed587460.jpg)

## 레플리카의 동작
```
레플리카는 실행 중인 파드의 목록을 지속적으로 모니터링하고 실제 파드 수가 원하는 
수와 일치하는지 확인한다. 
```

## 레플리카를 사용해 얻는 이점
```
파드가 없는 경우 새 파드를 시작해 파드가 항상 실행되도록 한다.

클러스터 노드에 장애가 발생하면 장애가 발생한 노드에서 실행 중인 모든 파드의
대체 복제본을 만든다.

수동으로 또는 자동으로 파드를 쉽게 수평 스케일링할 수 있다.
```

## kubectl scale 명령으로 스케일링 하기
```
특정 디플로이먼트의 레플리카 개수를 5로 만든다.
kubectl scale <deployment이름> --replicas=5
```

## 데몬셋으로 각 노드에 정확히 한 개의 파드 실행하기
```
클러스터의 각 노드에서 파드를 실행해야 하는 경우가 있다.

시스템 수준의 작업을 수행하는 인프라 관련 포드가 그러하다. 예를 들어 모든 노드에서
로그 수집기 및 리소스 모니터가 실행되길 원하는 경우이다.

또 하나의 예는 쿠버네티스의 자체 kube-proxy 프로세스다.
이 프로세스는 서비스가 정상 작동하려면 모든 노드에서 실행돼야 한다.

노드가 다운돼도 데몬셋은 어느 곳에서도 파드를 생성하지 않는다. 그러나 새 노드가 
클러스터에 추가되면 데몬셋은 즉시 파드 인스턴스를 배포한다.
```
![캡처66](https://user-images.githubusercontent.com/50174803/128542936-3d4d115e-ff83-4ad0-b870-89da283b59e7.jpg)

## 노드 셀렉터와 데몬셋을 사용해 특정 노드에만 시스템 파드 배포
![캡처77](https://user-images.githubusercontent.com/50174803/128543344-e7728c55-20bd-42cc-b246-bcf6492e546d.jpg)

## 완료 가능한 단일 태스크를 수행하는 파드 실행

```
- 잡 리소스
Job 리소스를 통해 내부에서 실행 중인 프로세스가 성공적으로 완료되면 컨테이너가 
다시 시작되지 않도록 하는 파드를 실행할 수 있다.

노드 장애가 발생하면 잡이 관리하는 해당 노드의 파드는 레플리카셋의 파드와 같은 방식으로
다른 노드로 재스케줄된다.

잡 파드는 무제한 실행되지 않으므로 restartPolicy 정책을 OnFailure 또는 Never로 명시해야 한다.
이 설정은 완료 시 컨테이너가 다시 시작하는 것을 방지한다.
```

## 잡에서 다수의 파드 인스턴스 실행

```
잡은 두 개 이상의 파드 인스턴스를 만들고 병렬 또는 순차적으로 실행할 수 있도록 구성할 수 있다.
이는 잡 스펙의 completion 와 parallelism 속성을 설정해 수행한다.
```
![캡처88](https://user-images.githubusercontent.com/50174803/128544017-452b7ba9-4ce3-465e-bbd4-5753d9e2cd96.jpg)

```
이 잡은 5개의 파드를 차례로 실행한다. 처음에는 하나의 파드를 만들고 파드 컨테이너가 완료되면
두 번째 파드를 만들고 5개의 파드가 성공적으로 완료될 때까지 계속한다.

파드 중 하나가 실패하면 잡이 새 파드를 생성하므로 전체적으로 보면 다섯 개 이상의 파드를
생성할 수도 있다.
```

```
- 병렬로 잡 파드 실행

단일 잡 파드를 하나씩 실행하는 대신 잡이 여러 개의 파드를 동시에 실행하도록
할 수 있다.
```
![캡처99](https://user-images.githubusercontent.com/50174803/128544281-222e32a5-3ef9-4d99-a4ae-336127ee48be.jpg)

## 잡을 주기적으로 또는 한 번만 실행하도록 스케줄링
```
잡 리소스는 생성될 때 즉시 파드를 실행한다. 그러나 많은 배치 작업은 특정 시간에 
실행되거나 지정된 간격으로 반복적으로 실행이 필요한 경우가 있다.

쿠버네티스의 예약 작업은 CronJob 리소스를 작성하여 구성된다.
```

## 요약
```
라이브니스 프로브를 지정해 쿠버네티스가 더 이상 정상적이지 못한 경우
즉시 컨테이너를 다시 시작하게 할 수 있다.

실수로 삭제된 경우, 실행 중인 노드가 실패한 경우 또는 노드에서 없어진 경우
파드가 재생성되지 않기 떄문에 파드를 직접 생성하면 안된다.

레플리카는 원하는 수의 파드 복제본을 항상 실행한다.

데몬셋은 모든 노드에서 데몬셋에서 정의한 파드의 단일 인스턴스를 실행한다.

배치 태스크를 수행하는 파드는 쿠버네티스의 잡 리소스를 통해 생성돼야 한다.

미래의 언젠가 실행이 필요한 잡은 CronJob 리소스를 통해 생성할 수 있다.
```




