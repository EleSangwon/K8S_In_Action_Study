# Chapter9 디플로이먼트: 애플리케이션을 선언적으로 업데이트하기 P377~418

```
이 장에서는 쿠버네티스 클러스터에서 애플리케이션을 업데이트하는 방법과 진정한 다운타임이 없는 
업데이트 프로세스를 위해 쿠버네티스가 도움을 줄 수 있는 부분에 대해 설명한다.
```

## 포드에서 실행 중인 애플리케이션 업데이트
```
모든 포드를 업데이트하는 두 가지 방법이 있다.
- 기존의 모든 포드를 삭제한 후, 새로운 포드 시작

- 새로운 것을 시작하고, 일단 끝나면 오래된 것을 지운다. 
모든 새로운 포드를 추가한 다음 한 번에 모든 기존 포드를 삭제하거나 순차적으로 새 포드를 추가하고
점차 오래된 포드를 제거할 수 있다.

첫 번째 옵션은 애플리케이션을 사용할 수 없는 짧은 시간이 발생한다.

두 번쨰 옵션은 애플리케이션에서 두 가지 버전의 애플리케이션 실행을 동시에 처리해야 한다.
애플리케이션에서 데이터를 데이터 스토리지에 저장하는 경우 새 버전은 이전 버전을 손상하는 방식으로 
데이터 스키마 또는 데이터를 수정해서는 안된다.
```
![캡처1](https://user-images.githubusercontent.com/50174803/131881152-7fa87f7b-41e2-47fc-8b63-04edc784df38.jpg)

## 오래된 포드를 삭제하고 새로운 포드로 교체
![캡2](https://user-images.githubusercontent.com/50174803/131881592-fde5c8ff-2b86-44d0-aa06-46936bc930df.jpg)


## 새 포드의 스핀업 및 오래된 포드 삭제
```
어떤 다운타임도 바라지 않고 애플리케이션이 동시에 여러 버전의 실행을 지원한다면 해당 프로세스로 먼저
전환하고 모든 새 포드를 스핀업한 다음 이전 포드만 삭제한다.

이를 위해서는 더 많은 하드웨어 리소스가 필요하다. 왜냐하면 짧은 시간 동안 한 번에 두 배의 포드가 
실행돼야 하기 때문이다.
```
![캡3](https://user-images.githubusercontent.com/50174803/131881960-bced98fd-df1a-44a4-9354-66b188b334e1.jpg)


## 롤링 업데이트
```
새 포드를 모두 가져오고 한 번에 이전 포드를 삭제하는 대신 포드를 단계적으로 대체하는 롤링 업데이트를
수행할 수 있다.

수동 롤링 업데이트는 힘들고 오류가 발생하기 쉽다. 복제본의 수에 따라 업데이트 프로세스를
수행하기 위해 많은 명령을 실행해야 한다. 쿠버네티스에서는 하나의 명령으로 롤링 업데이트를 수행할 수 있다.
```
![캡4](https://user-images.githubusercontent.com/50174803/131882294-dff1cd74-0421-4c96-a26b-4ef3721f2223.jpg)


## 선언적으로 애플리케이션을 업데이트하기 위한 디플로이먼트 사용하기
```
하위 수준 개념으로 간주되는 레플리카셋을 통해 업데이트를 수행하는 대신 디플로이먼트는 애플리케이션을
배포하고 이를 선언적으로 업데이트하는 데 사용하는 상위 수준의 리소스이다.

디플로이먼트를 만들면 레플리카셋 리소스가 아래에 만들어진다. 레플리카셋은 포드를 복제하고 관리한다.
디플로이먼트를 사용할 때 실제 포드는 디플로이먼트가 아니라 디플로이먼트의 레플리카셋에 의해 생성되고 관리된다.

디플로이먼트를 사용하면 단인 디플로이먼트 리소스를 통해 원하는 상태를 정의하기만 하면 쿠버네티스가 나머지 부분을
처리하므로 애플리케이션을 훨씬 쉽게 업데이트할 수 있다.
```

![캡5](https://user-images.githubusercontent.com/50174803/131882792-d302b12a-9e3b-424d-8efa-d309b055b776.jpg)

## 디플로이먼트 업데이트
```
업데이트를 위해 필요한 일은 디플로이먼트 리소스에 정의된 포드 템플릿을 수정하는 것뿐이다.
쿠버네티스는 리소스에 정의된 대로 실제 시스템 상태를 가져오는 데 필요한 모든 단계를 수행한다.

디플로이먼트의 포드 템플릿에서 새 이미지 태그를 참조해 시스템이 원하는 상태가 될 수 있도록
쿠버네티스에게 맡기면 된다.
```

## 가능한 디플로이먼트 전략
```
디폴트 전략은 RollingUpdate 라고 부르는 롤링 업데이트 전략을 수행하는 것이다.
RollingUpdate 전략은 오래된 포드를 하나씩 제거하는 동시에 새로운 포드를 추가해 전체 업데이트
프로세스에 걸쳐 애플리케이션을 사용할 수 있도록 하며 요청을 처리할 수 있는 용량이 줄어들지 않도록 한다.
```
![캡6](https://user-images.githubusercontent.com/50174803/131884708-141b7871-fd0f-4ede-ae95-ee00d4f13752.jpg)

## 롤아웃 되돌리기
```
kubectl rollout undo deployment <deployment-name>
명령어를 통해 해당 디플로이먼트를 이전 버전으로 롤백할 수 있다.

kubectl rollout undo deployment <deployment-name> --to-revision=1
명령어를 통해 특정 디플로이먼트 리비전으로 롤백할 수 있다.
```
![캡7](https://user-images.githubusercontent.com/50174803/131885115-e27310a4-51f6-4950-8632-e46401799899.jpg)



